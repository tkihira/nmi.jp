<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>JavaScript で学ぶビット演算の基礎</title>
    <meta name="description" content="唐突にビット演算の話です。今回は本当に基礎的な事しか書きませんので、ある程度のレベルの方には常識レベルの話になることをご承知ください。近年のプログラミング環境で、ビットを意識する機会はほとんど無くなりました。プログラミングの抽象化が進んだおかげで良いことだと思います。今や知らないのが普通なのかもしれません。しかし...">

    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript">
    <link rel="alternate" type="application/rss+xml" title="nmi.jp" href="https://nmi.jp/feed.xml">
<script type='text/javascript' src='http://platform.twitter.com/widgets.js?ver=3.0'></script>
<script type='text/javascript' src='http://platform.twitter.com/widgets.js?ver=1.1'></script>
    <script>
        if(location.href.match(/\.html$/)) {
            location.href = location.href.match(/(.+)\.html/)[1];
        }
    </script>


<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-229769-8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-229769-8');
</script>
</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">nmi.jp</a>
        <small>Twitter → <a href="https://twitter.com/tkihira" target="_blank">@tkihira</a></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <div class="post-recent">
    <table style="width:100%;border:0;padding:0;"><tbody><tr style="padding:0">
        <td class="toppre" style="padding:0">
        
        <a href="/2021-09-09-NaN">JavaScript クイズ解説: NaN === NaN の結果はどうなる？</a>
        
        </td><td class="topnex" style="text-align:right;padding:0">
        
        <a href="/2022-02-03-dont-use-parseInt">JavaScript で parseInt / parseFloat を使わない方が良い理由</a>
        
        </td>
    </tr></tbody></table>
</div>

        <hr style="margin:0"/>
        <h1 style="margin-top:10px">JavaScript で学ぶビット演算の基礎</h1>
<hr />
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2022-01-24
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>Takuo Kihira
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#JavaScript" title="Category: JavaScript" rel="category">JavaScript</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
                <a href="https://github.com/tkihira/nmi.jp/blob/master/_posts/2022-01-24-Bitwise-operation-with-JavaScript.md" target="_blank"><i class="fa fa-github"></i></a>
            </div>

        </div>

<div class="entry fix" style="overflow:hidden;">
    <div style="height:33px; padding-top:2px; padding-bottom:2px; clear:both;" class="really_simple_share"><div style="float:left; width:100px; " class="really_simple_share_facebook_like"> 
				<iframe src="//www.facebook.com/plugins/like.php?href=https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript&amp;layout=button_count&amp;show_faces=false&amp;width=100&amp;action=like&amp;colorscheme=light&amp;height=27" 
					scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:27px;" allowTransparency="true"></iframe>
			</div><div style="float:left; width:110px; padding-left:10px;" class="really_simple_share_twitter"> 
				<a href="//twitter.com/share" class="twitter-share-button" data-count="horizontal" 
					data-text="JavaScript で学ぶビット演算の基礎" data-url="https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript">Tweet</a> 
			</div><div style="float:left; padding-left:10px;" class="really_simple_share_hyves">
					<a href="//b.hatena.ne.jp/entry/https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript" class="hatena-bookmark-button"
					data-hatena-bookmark-layout="standard" title="JavaScript で学ぶビット演算の基礎"
					><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="JavaScript で学ぶビット演算の基礎" width="20"
					height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js"
					charset="utf-8" async="async"></script>
				</div>
</div>
</div>
        <article itemscope itemtype="//schema.org/BlogPosting">
        <p>唐突にビット演算の話です。今回は本当に基礎的な事しか書きませんので、ある程度のレベルの方には常識レベルの話になることをご承知ください。</p>

<p>近年のプログラミング環境で、ビットを意識する機会はほとんど無くなりました。プログラミングの抽象化が進んだおかげで良いことだと思います。今や<span style="color:blue">知らないのが普通</span>なのかもしれません。しかし、もしちょっと低レイヤーな処理を書く機会があった時に、今までの私達にとっては常識レベルであった知識であっても、重要度が下がり学ぶ機会も無くなってしまったが故に、知らない人はそこで躓いてしまう可能性が高いことに気が付きました。この記事は、普段のプログラミングにはあまり必要のないビット演算を、とりあえずこれだけ知っておけばその先は自力でなんとかなるかな、というレベルまで解説したいと思います。</p>

<p>解説は JavaScript を使って行いますが、基本は他の言語でも同じです。</p>

<h1 id="javascript-における数値">JavaScript における数値</h1>

<p>JavaScript には数値型がありますが、それは浮動小数点数です。今回は細かい話はしませんが、整数だと <code class="language-plaintext highlighter-rouge">Number.MAX_SAFE_INTEGER === 9007199254740991</code> と <code class="language-plaintext highlighter-rouge">Number.MIN_SAFE_INTEGER === -9007199254740991</code> の間の数字は誤差が出ることなく扱えます。</p>

<p>一方で、ECMAScript の仕様により、演算途中で整数を 32bit 整数に変換する命令がいくつかあります。それにより変換されると、32bit の整数の表現範囲を超えると扱えなくなります。例えば、</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mi">12345678901</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// === -539222987</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">&gt;&gt; 0</code> は意味的には右に 0 ビットシフト（＝本来意味のない演算）ですが、JavaScript ではビットシフト命令を呼ぶと内部で 32bit 整数に変換され、結果として 32bit の範囲を超えた数字が扱えなくなります。32bit の数字は、符号付き（singed）だと <code class="language-plaintext highlighter-rouge">2147483647</code> 〜 <code class="language-plaintext highlighter-rouge">-2147483648</code> の値が、符号無し（unsigned）だと <code class="language-plaintext highlighter-rouge">4294967295</code> 〜 <code class="language-plaintext highlighter-rouge">0</code> までの値が利用可能です。なぜこのような値になるのかについては後で説明します。</p>

<p>ここではとりあえず、「今日は 32bit の話をするので 2147483647 〜 -2147483648 くらいの数字を扱うんだな」と思っておいてください。</p>

<p>あと、この記事中で <code class="language-plaintext highlighter-rouge">0b11010011</code> みたいな表記を使いますが、これは JavaScript の 2 進数リテラルで、2 進数で <code class="language-plaintext highlighter-rouge">11010011</code> を表記する方法です。また、 <code class="language-plaintext highlighter-rouge">x ** y</code> は、x の y 乗を計算する演算子です。念のために記しておきます。</p>

<h1 id="ビットとは">ビットとは</h1>

<p>数は、コンピュータの中ではビットの集まりで表現されます。32bit の整数の場合、32 個のビットを使って 1 つの数字を表します。ビットは 0 か 1 を取る単位であり、32bit の整数は 32 個並んだビットを何らかの数字に紐付けているのです。</p>

<p>ビットの表現を無駄なく整数に紐付けるために、2 進数を用いて表現しています。例えば <code class="language-plaintext highlighter-rouge">01101001</code> という 8bit の数があった場合、</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">0</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="mb">0b01101001</span> <span class="c1">// === 105</span>
</code></pre></div></div>

<p>となります。これは 32 bit になっても 64 bit になっても変わりません。桁ごとの計算がわからないという方は、10 進数に置き換えるとわかりやすいと思います。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">7</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">6</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">5</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">6</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">7</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span>
<span class="mi">8</span> <span class="o">*</span> <span class="p">(</span><span class="mi">10</span> <span class="o">**</span> <span class="mi">0</span><span class="p">)</span> <span class="o">===</span> <span class="mi">12345678</span>
</code></pre></div></div>

<p>もし 32bit を全部使った場合、<code class="language-plaintext highlighter-rouge">0b11111111111111111111111111111111 === 4294967295 (=== 2 ** 32 - 1)</code> が最大値となります。しかし、この表現だと一番小さい値はゼロになり、マイナスの整数を表現することが出来ません。こういった表現を一般的に「符号なし整数（unsigned integer）」と呼びます。32bit の符号なし整数の最大値は <code class="language-plaintext highlighter-rouge">4294967295</code> となります。最小値は <code class="language-plaintext highlighter-rouge">0</code> です。</p>

<p>余談ですが、ファミコン版のドラクエ 4 の 5 章のカジノで 20G のコインを 838861 枚買うと 4G で買えてしまう裏技は、ドラクエ 4 の内部処理で 24bit の符号なし整数で扱っていたためです。24bit の符号なし整数の最大値は <code class="language-plaintext highlighter-rouge">(2 ** 24 - 1) === 16777215</code> で、これを超えるとオーバーフローした数字が無視される実装であったため、<code class="language-plaintext highlighter-rouge">838861 * 20 - 2 ** 24 = 4</code> ということで 4 ゴールドになってしまうバグでした。</p>

<h1 id="マイナスの表現2の補数">マイナスの表現（2の補数）</h1>

<p>ではここから、マイナスの整数を考えてみましょう。先程の <code class="language-plaintext highlighter-rouge">01101001 === 105</code> という数に対して、8bit 整数で -105 を表現するにはどうするのが良いでしょうか？</p>

<p>-105 を <code class="language-plaintext highlighter-rouge">x</code> と置いてみましょう。当然ながら、<code class="language-plaintext highlighter-rouge">105 + x = 0</code> になります。これを 2 進数で考えると、</p>

<pre>
  01101001
+)xxxxxxxx
----------
  00000000
</pre>

<p>となってくれれば理想的ですが、たとえ 2 進数でも正の数に何を足してもゼロになることはありません。しかしここで「8 bit より上の桁にあふれても無視する」という条件を入れてみるとどうでしょうか？</p>

<pre>
  01101001
+)xxxxxxxx
----------
 100000000
</pre>

<p>9 桁目に 1 が出てきてもそれを無視する、という条件になりましたので、100000000 を作るための足し算になります。これなら <code class="language-plaintext highlighter-rouge">x</code> が求まりそうですよね！実際には次のようになります。</p>

<pre>
  01101001
+)10010111
----------
 100000000
</pre>

<p>8bit 表現において、<code class="language-plaintext highlighter-rouge">10010111</code> を -105 とすると足し算が計算しやすいことがわかりました。このようなマイナスの整数の表現を「2の補数」と呼びます。これは 32bit でも全く同じで、</p>

<pre>
  0000 0000 0000 0000 0000 0000 0110 1001
+)1111 1111 1111 1111 1111 1111 1001 0111
-----------------------------------------
1 0000 0000 0000 0000 0000 0000 0000 0000
</pre>

<p>となり、実際 JavaScript において <code class="language-plaintext highlighter-rouge">0b11111111111111111111111110010111 &gt;&gt; 0 === -105</code> となります。</p>

<p>2 の補数の表現において、一番上のビットが 1 であることはマイナスであることを示します（一番上のビットのことを符号ビットと呼びます）。なので、32bit において一番大きな正の整数は、一番上のビットをゼロにする必要があるので</p>

<p><code class="language-plaintext highlighter-rouge">0b01111111111111111111111111111111 === 2147483647</code></p>

<p>となるのです。</p>

<p>正の整数から負の整数のビット表現に変換するには、「正の整数から 1 を引いて、その後全ビットをひっくり返す」という工程で行えます。例えば <code class="language-plaintext highlighter-rouge">-2147483647</code> という数を作る場合、</p>

<p><code class="language-plaintext highlighter-rouge">0b01111111111111111111111111111111 - 1 === 0b01111111111111111111111111111110</code></p>

<p>と 1 を引いた後に、</p>
<pre>
0111 1111 1111 1111 1111 1111 1111 1110
                 ↓↓↓↓↓
1000 0000 0000 0000 0000 0000 0000 0001
</pre>

<p>と 0 と 1 をひっくり返した、<code class="language-plaintext highlighter-rouge">0b10000000000000000000000000000001 &gt;&gt; 0 === -2147483647</code> となります。 <code class="language-plaintext highlighter-rouge">&gt;&gt; 0</code> は ECMAScript の仕様を利用して符号付き 32bit 整数に変換しています。</p>

<p>なお、1 から -1 を作るとわかるように、 <code class="language-plaintext highlighter-rouge">1 - 1 === 0</code> となり、ゼロは全てのビットがゼロなので、それを反転して全てのビットが立った <code class="language-plaintext highlighter-rouge">0b11111111111111111111111111111111 &gt;&gt; 0 === -1</code> となります。</p>

<p>2 の補数表現の場合、 <code class="language-plaintext highlighter-rouge">0b10000000000000000000000000000000 &gt;&gt; 0 === -2147483648</code> がマイナスで一番大きな値になります。正の数の最大値が <code class="language-plaintext highlighter-rouge">2147483647</code> なので、 <code class="language-plaintext highlighter-rouge">-2147483648</code> はそれより絶対値で 1 大きくなります。これは 2 の補数の特色でもあります。</p>

<p>このように、符号付き 32bit 整数では <code class="language-plaintext highlighter-rouge">-2147483648</code> 〜 <code class="language-plaintext highlighter-rouge">2147483647</code> までの整数を扱うことが出来るわけです。</p>

<p>余談ですが、スーパーマリオブラザーズで無限 1up をし続けて残機が 127 を超えると即ゲームオーバーになってしまうのは、8bit 整数でビットの足し算をし続けた結果、<span style="color:red">128 機を超えたタイミングで一番上のビットが立ってしまい、結果として残機がマイナスと判断されてしまう</span>ためです。</p>

<h1 id="ビット演算">ビット演算</h1>

<p>整数の表現方法がわかった所で、次は主なビット演算を解説します。</p>

<h2 id="not--ビット否定-">NOT / ビット否定 (~)</h2>

<p>先程「全ビットをひっくり返す」と言いましたが、まさにその演算をビット否定と呼びます。JavaScript の場合の演算子は <code class="language-plaintext highlighter-rouge">~</code> です。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b11001100001010110101011110000100</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="o">~</span><span class="nx">a</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div>

<p>この出力結果を整形すると、こうなります</p>

<pre>
 a: 11001100001010110101011110000100
~a: 00110011110101001010100001111011
</pre>

<p>0 が 1 に、1 が 0 に変わっているのが確認できます。</p>

<p>先程 2 の補数の項で紹介した、「1 を引いて、その後全ビットをひっくり返す」というのをコードにしてみました。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">positive</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2147483647</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">positive</span><span class="p">);</span> <span class="c1">// 例えば 1692412457</span>
<span class="kd">const</span> <span class="nx">negative</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="nx">positive</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">negative</span><span class="p">);</span> <span class="c1">// 例えば -1692412457</span>
</code></pre></div></div>

<p>ビット演算で正の整数から負の整数に変換出来ていることが確認出来ます。</p>

<p>2の補数の項で述べた通り、0 のビット否定は -1 になります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="o">~</span><span class="mi">0</span> <span class="o">===</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span> <span class="c1">// true</span>
</code></pre></div></div>

<p>また、ビット否定を 2 回繰り返すと元の値に戻ります。JavaScript において、ビット演算は強制的に数値を 32bit 整数に変換するので、これを利用して以前小数を整数にするテクニックがありましたが、可読性に劣るので使うのはやめましょう。今は <code class="language-plaintext highlighter-rouge">Math.trunc</code> という関数で同じことが出来ます。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="o">~~</span><span class="mf">4.3</span> <span class="o">===</span> <span class="mi">4</span><span class="p">);</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="o">~~-</span><span class="mf">3.5</span> <span class="o">===</span> <span class="o">-</span><span class="mi">3</span><span class="p">);</span> <span class="c1">// true</span>
</code></pre></div></div>

<p>余談ですが、JavaScript では <code class="language-plaintext highlighter-rouge">Number(true) === 1</code> <code class="language-plaintext highlighter-rouge">Number(false) === 0</code> ですが、一部の言語（VB.NET とか N88BASIC とか）は <span style="color:blue">TRUE が -1 であることがあります</span>。それは FALSE が 0 であり、それをビット否定すると -1 になるためです。 <code class="language-plaintext highlighter-rouge">NOT FALSE == TRUE</code> ってことですね。TRUE を数字に変換出来る場合でも、常に 1 とは限らないのです。</p>

<h2 id="and--ビット論理積-">AND / ビット論理積 (&amp;)</h2>

<p>ビット論理積、一般的には単に AND、もしくは目的によってはマスクと呼ばれます。JavaScript の場合の演算子は <code class="language-plaintext highlighter-rouge">&amp;</code> です。<code class="language-plaintext highlighter-rouge">A &amp; B</code> と呼ばれた場合、A と B の両方でビットが 1 だった場合のみ 1 になります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b01001100001010110101011110000100</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mb">0b00111001110100000010110011010011</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">a</span> <span class="o">&amp;</span> <span class="nx">b</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div>

<p>この出力結果を整形すると、こうなります</p>

<pre>
  A: 01001100001010110101011110000100
  B: 00111001110100000010110011010011
A&amp;B: 00001000000000000000010010000000
</pre>

<p>両方 0、もしくは片方 0 の桁の出力が 0 に、両方 1 の桁の出力が 1 になっているのが確認出来ますね。</p>

<p>AND は、「マスク」によく使われます。自分が必要としている桁だけを残す使い方です。例えば A の 下位 16bit だけほしい、と思った場合、</p>

<pre>
  A: 0100 1100 0010 1011 <span style="color:blue">0101 0111 1000 0100</span>
  B: 0000 0000 0000 0000 1111 1111 1111 1111
A&amp;B: 0000 0000 0000 0000 <span style="color:blue">0101 0111 1000 0100</span>
</pre>

<p>このような形で <code class="language-plaintext highlighter-rouge">0b1111111111111111 === 0xffff</code> で AND を取ることにより、A の下位ビットだけを抽出することが出来ます。同じ用に <code class="language-plaintext highlighter-rouge">0xffff0000</code> で AND を取ると、今度は A の上位 16 bit だけを得ることが出来ます。AND を使う場合、ほとんどがこの「マスク」の処理だと考えてもよいくらい多用されています。</p>

<h2 id="or--ビット論理和-">OR / ビット論理和 (|)</h2>

<p>ビット論理和、一般的にはビット OR もしくは単に OR と呼ばれます。JavaScript の場合の演算子は <code class="language-plaintext highlighter-rouge">|</code> です。<code class="language-plaintext highlighter-rouge">A | B</code> と呼ばれた場合、A と B のどちらか片方でビットが 1 だった場合に 1 になります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b01001100001010110101011110000100</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mb">0b00111001110100000010110011010011</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">a</span> <span class="o">|</span> <span class="nx">b</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div>

<p>この出力結果を整形すると、こうなります</p>

<pre>
  A: 01001100001010110101011110000100
  B: 00111001110100000010110011010011
A|B: 01111101111110110111111111010111
</pre>

<p>片方だけでも 1 の桁の出力が 1 に、両方 0 の桁の出力が 0 になっているのが確認出来ますね。</p>

<p>OR は、AND で「マスク」された結果に対して上書きする時に多用されます。先程 AND の例で <code class="language-plaintext highlighter-rouge">0xffff0000</code> でマスクして上位 16bit だけ得る話をしましたが、その下位 16bit に任意の数を書き込む時に OR がよく使われるイメージです。</p>

<p>まず、適当な A に対して <code class="language-plaintext highlighter-rouge">M = 0xffff0000</code> で AND してみましょう</p>

<pre>
  A: <span style="color:blue">0100 1100 0010 1011</span> 0101 0111 1000 0100
  M: 1111 1111 1111 1111 0000 0000 0000 0000
A&amp;M: <span style="color:blue">0100 1100 0010 1011</span> 0000 0000 0000 0000
</pre>

<p>その結果に対して、<code class="language-plaintext highlighter-rouge">W = 0x00001234</code> で OR してみましょう</p>

<pre>
  A&amp;M: 0100 1100 0010 1011 0000 0000 0000 0000
    W: 0000 0000 0000 0000 <span style="color:red">0001 0010 0011 0100</span>
A&amp;M|W: 0100 1100 0010 1011 <span style="color:red">0001 0010 0011 0100</span>
</pre>

<p>このように、下位 16bit に 0x1234 を埋め込むことが出来ました。この例だと足し算でも良いのですが、足し算だとビットを書き込むという意図が伝わらないので OR を使うのが望ましいです。（40 年前とかだと、足し算より OR の方が速く、その速度差がクリティカルだった、みたいな話もあったりはしますが、少なくとも現代の JavaScript では気にする必要はないです）</p>

<p>OR は、ビットを使ってフラグを書き込む時などにも使われます。例えば 4 ビットの整数に対して、</p>

<ul>
  <li>上位 1 ビット目: 敵から痛恨の一撃を食らったフラグ</li>
  <li>上位 2 ビット目: 味方が会心の一撃を出したフラグ</li>
  <li>上位 3 ビット目: 敵から攻撃を食らったフラグ</li>
  <li>上位 4 ビット目: 味方が攻撃したフラグ</li>
</ul>

<p>みたいに用意した場合、もし味方が会心の一撃を出したら、何も考えずに <code class="language-plaintext highlighter-rouge">flag |= 0b0100</code> と書けます。足し算の場合、元のフラグの上位 2bit 目が 0 ならばいいのですが、もし 1 だった場合は桁あふれして上位 1 ビットの値を変えてしまいます。余談ですが、<span style="color:blue">ファミコンのドラクエ 4 で 8 回逃げると会心の一撃ばかり出る裏技は、まさにこの足し算で余計な場所のフラグを立ててしまいバグを出してしまった例</span>ですね。</p>

<p>このフラグをチェックする場合、 <code class="language-plaintext highlighter-rouge">if (flag &amp; 0b0100) { ... }</code> というような形で書きます（実際は <code class="language-plaintext highlighter-rouge">0b0100</code> を使わずに <code class="language-plaintext highlighter-rouge">0x4</code> と書くことが多いです。<span style="color:red">ビット演算を使う人は、16 進数の 0x1 0x2 0x4 0x8 と 0x7 0xf のビットの立ち方は魂で覚えている</span>ことが多いです）</p>

<h1 id="xor--ビット排他的論理和-">XOR / ビット排他的論理和 (^)</h1>

<p>ビット排他的論理和、一般には XOR（エックスオア）と呼ばれる演算です。<strong>XOR は面白いんですが、実際に使われることはそんなにありません</strong> 。特性だけ覚えておきましょう。</p>

<p>JavaScript の場合の演算子は <code class="language-plaintext highlighter-rouge">^</code> です。<code class="language-plaintext highlighter-rouge">A ^ B</code> と呼ばれた場合、A と B のビットが同じだった場合は 0、違った場合は 1 になります。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">A</th>
      <th style="text-align: center">B</th>
      <th style="text-align: center">A ^ B</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">0</td>
    </tr>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
      <td style="text-align: center">1</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0</td>
    </tr>
  </tbody>
</table>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b01001100001010110101011110000100</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mb">0b00111001110100000010110011010011</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">b</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">a</span> <span class="o">^</span> <span class="nx">b</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</code></pre></div></div>

<p>この出力結果を整形すると、こうなります</p>

<pre>
  A: 01001100001010110101011110000100
  B: 00111001110100000010110011010011
A^B: 01110101111110110111101101010111
</pre>

<p>A と B が同じ値だと 0 に、違う値だと 1 になることが確認出来るかと思います。</p>

<p><span style="color:red">XOR の重要な特性として、同じ値で 2 回 XOR を取ると元の値に戻る</span>というものがあります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">a</span> <span class="o">=</span> <span class="mb">0b01001100001010110101011110000100</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">b</span> <span class="o">=</span> <span class="mb">0b00111001110100000010110011010011</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">a</span> <span class="o">===</span> <span class="p">(</span><span class="nx">a</span> <span class="o">^</span> <span class="nx">b</span> <span class="o">^</span> <span class="nx">b</span><span class="p">));</span> <span class="c1">// true</span>
</code></pre></div></div>

<pre>
    A: <span style="color:blue">01001100001010110101011110000100</span>
    B: 00111001110100000010110011010011
  A^B: 01110101111110110111101101010111
    B: 00111001110100000010110011010011
A^B^B: <span style="color:blue">01001100001010110101011110000100</span>
</pre>

<p>この特性は、文字列などの難読化の初歩の初歩に使われることがあります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">TestString</span><span class="dl">'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">encoded</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">str</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nf">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x33</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">encodedStr</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nf">fromCharCode</span><span class="p">(...</span><span class="nx">encoded</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">encodedStr</span><span class="p">);</span> <span class="c1">// gV@G`GAZ]T</span>

<span class="kd">const</span> <span class="nx">decoded</span> <span class="o">=</span> <span class="p">[...</span><span class="nx">encodedStr</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="nx">v</span> <span class="o">=&gt;</span> <span class="nx">v</span><span class="p">.</span><span class="nf">charCodeAt</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x33</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">decodedStr</span> <span class="o">=</span> <span class="nb">String</span><span class="p">.</span><span class="nf">fromCharCode</span><span class="p">(...</span><span class="nx">decoded</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">decodedStr</span><span class="p">);</span> <span class="c1">// TestString</span>
</code></pre></div></div>

<p>また、XOR は同じ値同士で演算すると 0 になります。</p>

<pre>
    A: 01001100001010110101011110000100
    B: 01001100001010110101011110000100
  A^B: 00000000000000000000000000000000
</pre>

<p>アセンブラで eax に 0 を代入する時に <code class="language-plaintext highlighter-rouge">MOV EAX, 0</code> よりも <code class="language-plaintext highlighter-rouge">XOR EAX, EAX</code> がよく使用されますが、これは XOR の方がインストラクションのバイト数が短くバイナリが小さくなるため XOR を利用しているそうです。昔は MOV よりも XOR の方が速かったのですが、今はどうなのかわかりません。<a href="https://www.google.com/search?q=XOR+EAX%2CEAX+MOV+EAX%2C0">検索すると世界中の人が議論していて面白いです</a>。</p>

<p>余談ですが、XOR を使って変数の値を入れ替えるネタがあります。もちろんこんなコードを書かないようにしてくださいね。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span> <span class="nx">x</span> <span class="o">=</span> <span class="mi">12345678</span><span class="p">;</span>
<span class="kd">let</span> <span class="nx">y</span> <span class="o">=</span> <span class="mi">98765432</span><span class="p">;</span>
<span class="nx">x</span> <span class="o">^=</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">y</span> <span class="o">^=</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">x</span> <span class="o">^=</span> <span class="nx">y</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">({</span><span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">});</span> <span class="c1">// {x: 98765432, y: 12345678}</span>
</code></pre></div></div>

<h1 id="左シフト-">左シフト (<code class="language-plaintext highlighter-rouge">&lt;&lt;</code>)</h1>

<p>左シフトは、ビットを左にずらします。右の空いたところには 0 が入ります。32bit の桁から溢れたビットは捨てられます。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 1111011</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 11110110</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 11110110000</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 1111011000000000000000000000000</span>
</code></pre></div></div>

<p>2 進数の性質上、桁あふれさえしなければ、左ビットシフトは 2 の累乗の掛け算の結果と等しくなります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nx">num</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="nx">num</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">4</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">===</span> <span class="nx">num</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">24</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">===</span> <span class="nx">num</span> <span class="o">*</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">25</span><span class="p">));</span> <span class="c1">// false: 123 を 25bit 左にシフトすると signed 32bit からあふれてしまう</span>
</code></pre></div></div>

<p>10 進数で右にゼロを 1 個追加したら 10 倍に、2 個追加したら 100 倍になるのと同じですね。ただこのテクニックは可読性が良くないので、通常の要件においてはあまり使わない方が良いでしょう。</p>

<h1 id="符号なし右シフト-">符号なし右シフト (<code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;</code>)</h1>

<p><code class="language-plaintext highlighter-rouge">&gt;&gt;</code> より先に <code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;</code> を説明します。符号なし右シフトは、ビットを右にずらします。右の空いたところには、0 が入ります。一番下のビットは捨てられます。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 1111011</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 111101</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 111</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">24</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 0</span>
</code></pre></div></div>

<p>これも 2 進数の性質上、右ビットシフトは、2 の累乗の割り算の結果を切り捨てしたものと等しくなります。これも可読性が良くないので、通常の要件においてはあまり使わない方が良いでしょう。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">24</span><span class="p">)));</span> <span class="c1">// true, ゼロだけど</span>
</code></pre></div></div>

<p>またこれは JavaScript 特有なのですが、符号なし右シフトを使うと、結果が符号なし（unsigned）の 32bit 整数になります。他のビット演算は全て符号あり（signed）32bit 整数になるので、この特性を利用して unsigned 32bit 整数を得ることがよくあります。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mb">0b10000000000000000100000000000000</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// -2147467264</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span> <span class="c1">// 2147500032 ← 符号付き 32bit 整数の上限を超えている</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// -1111111111111111100000000000000</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 10000000000000000100000000000000</span>
</code></pre></div></div>

<p>3 つ目のマイナスの 2 進数は ECMAScript の Number#toString の仕様上マイナスの数字はこうなってしまうのですが、 <code class="language-plaintext highlighter-rouge">&gt;&gt;&gt; 0</code> で符号なし 32bit 整数に変換することで本来の bit 表現を得ることが出来ました。</p>

<h1 id="右シフト-">右シフト (<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>)</h1>

<p>右シフトは、ビットを右にずらします。右の空いたところには、 <strong>一番上位ビットの数がそのまま入ります</strong> 。一番下のビットは捨てられます。</p>

<p>一番上のビットがゼロの場合は、普通にビットが右に行くだけ、<code class="language-plaintext highlighter-rouge">&gt;&gt;&gt;</code> と全く同じです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 1111011</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 111101</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 111</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 0</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mi">123</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)));</span> <span class="c1">// true</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">===</span> <span class="nb">Math</span><span class="p">.</span><span class="nf">trunc</span><span class="p">(</span><span class="nx">num</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="mi">24</span><span class="p">)));</span> <span class="c1">// true, ゼロだけど</span>
</code></pre></div></div>

<p>さて問題は一番上のビットが 1 の場合です。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="p">(</span><span class="mb">0b10000000000000000100000000000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 11000000000000000010000000000000</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 11111000000000000000010000000000</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">((</span><span class="nx">num</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&gt;&gt;&gt;</span> <span class="mi">0</span><span class="p">).</span><span class="nf">toString</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span> <span class="c1">// 11111111111111111111111110000000</span>
</code></pre></div></div>

<p>2 の補数の項で説明した通り、一番上のビットが 1 であるとその整数表現は必ずマイナスになります。なので、<code class="language-plaintext highlighter-rouge">&gt;&gt;</code> でビットシフトをする場合、マイナスを維持したままビットシフトをしていることになります。これが大きな意味を持つのが「符号拡張」と呼ばれる場面です。</p>

<h2 id="符号拡張">符号拡張</h2>

<p>上の 2 の補数の解説で、8bit の整数であれば <code class="language-plaintext highlighter-rouge">10010111</code> が -105 を表現する、という話をしました。しかし JavaScript は 8bit の整数型を持たないので（TypedArray を使えば実現出来るのですが）、<code class="language-plaintext highlighter-rouge">0b10010111 === 151</code> と全然違う数字になってしまいます。</p>

<p>これを 32bit に拡張するのを「符号拡張」と言います。8bit の整数を 32bit の整数に拡張する場合、24bit 拡張する必要があります。そこで、まず <code class="language-plaintext highlighter-rouge">10010111</code> を 24 bit 左にシフトします。そうすると、右に 24 個の 0 が追加されるので、</p>

<p><code class="language-plaintext highlighter-rouge">1001 0111 0000 0000 0000 0000 0000 0000</code></p>

<p>となります。今度はこれを符号付きシフト(<code class="language-plaintext highlighter-rouge">&gt;&gt;</code>)で 24 ビットシフトしてみましょう。一番上のビットが 1 なので、次のようになります。</p>

<p><code class="language-plaintext highlighter-rouge">1111 1111 1111 1111 1111 1111 1001 0111</code></p>

<p>これで、本来欲しかった 32bit 整数の -105 を得ることが出来ました。コードにすると次の通りです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mb">0b10010111</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span><span class="p">);</span> <span class="c1">// 151</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span> <span class="c1">// -105</span>
</code></pre></div></div>

<p>一番上のビットがゼロの場合は、ただ24ビット移動するだけで何の変化もありません。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">num</span> <span class="o">=</span> <span class="mb">0b01101001</span><span class="p">;</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span><span class="p">);</span> <span class="c1">// 105</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">num</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">);</span> <span class="c1">// 105</span>
</code></pre></div></div>

<p>同じ数でシフトの往復ビンタをしている時は、まず間違いなくこの符号拡張をしています。整数のビット数を変換する時に極めて一般的な手法ですので、見たら「あれか！」と思い出すくらいには心に留めておくと良いと思います。</p>

<h1 id="まとめ">まとめ</h1>

<p>余談を書きすぎたせいか、思ったより長くなりました。次はここからリトルエンディアン＆ビッグエンディアンの話や浮動小数点の表現などに進んでいったりするのが良いのでしょうが、とりあえずここまで完全に理解しておけば、いきなりビット演算の世界に放り込まれてもソースを読むことくらいは出来るのではないかと思います。</p>

<p>ビット演算なんて知らなくても、2 の補数なんて意識しなくても、プログラムを書く上でそんなに困ることはないのかもしれません。ただ、必要がない故に学ぶ機会も同様に減っているのは少し残念だな、と思って記事にしてみました。釈迦に説法だった人も多いかと思いますが、もし知らない内容をこの記事で学べた、ということがあれば本望です。</p>

        </article>
        <hr>

<div class="entry fix" style="overflow:hidden;">
    <div style="height:33px; padding-top:2px; padding-bottom:2px; clear:both;" class="really_simple_share"><div style="float:left; width:100px; " class="really_simple_share_facebook_like"> 
				<iframe src="//www.facebook.com/plugins/like.php?href=https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript&amp;layout=button_count&amp;show_faces=false&amp;width=100&amp;action=like&amp;colorscheme=light&amp;height=27" 
					scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:27px;" allowTransparency="true"></iframe>
			</div><div style="float:left; width:110px; padding-left:10px;" class="really_simple_share_twitter"> 
				<a href="//twitter.com/share" class="twitter-share-button" data-count="horizontal" 
					data-text="JavaScript で学ぶビット演算の基礎" data-url="https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript">Tweet</a> 
			</div><div style="float:left; padding-left:10px;" class="really_simple_share_hyves">
					<a href="//b.hatena.ne.jp/entry/https://nmi.jp/2022-01-24-Bitwise-operation-with-JavaScript" class="hatena-bookmark-button"
					data-hatena-bookmark-layout="standard" title="JavaScript で学ぶビット演算の基礎"
					><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="JavaScript で学ぶビット演算の基礎" width="20"
					height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js"
					charset="utf-8" async="async"></script>
				</div>
</div>
</div>

        
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        

        <div class="post-recent">
    <div class="pre">

    
        <p><strong>前の投稿</strong> <a href="/2021-09-09-NaN">JavaScript クイズ解説: NaN === NaN の結果はどうなる？</a></p>
    
    </div>
    <div class="nex">

        
        <p><strong>次の投稿</strong> <a href="/2022-02-03-dont-use-parseInt">JavaScript で parseInt / parseFloat を使わない方が良い理由</a></p>
        
    </div>
</div>


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>


    <div class="right">
        <div class="wrap">
            <div class="side">
                <div>
                    <i class="fa fa-tags"></i>
                    Top Popular Posts
                </div>
                <ul class="content-ul" recent>
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/2016-07-23-stock-strategy-for-early-startup-employee">スタートアップに転職する時に最低限知っておくべき株の話</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/582">生WebGL入門:初音ミクの美麗3Dモデルを表示する(前編)</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/2017-10-06-Making_a-business_plan">事業計画書の作り方、新規ビジネスの考え方</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/902">Convertible Note / Convertible Equity とは？</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/488">JavaScript イディオム集</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/465">ExGameの製作で感じたこと</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                </ul>
            </div>

            <div class="side">
                <div>
                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    Recent Posts
                </div>
                <ul class="content-ul" recent>
                    
                        <li><a href="/2024-08-28-Review-Binary-Hacks-Rebooted">書評 "Binary Hacks Rebooted"</a></li>
                    
                        <li><a href="/2024-06-10-Deep-Dive-into-ARM-JavaScript-Special-Instruction-FJCVTZS">ARM に存在する JavaScript 専用命令「FJCVTZS」を追う（ついでに V8 をビルドする）</a></li>
                    
                        <li><a href="/2024-06-03-Exploring-V8-JIT-Outputs">JavaScript 実行エンジン V8 の JIT 出力コードを読んでみよう</a></li>
                    
                </ul>
            </div>

            <!-- <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    Links
                </div>
                <ul  class="content-ul">

                </ul>
            </div> -->
        </div>
    </div>



</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             Takuo Kihira 
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/tkihira" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>     
            <a href="https://twitter.com/tkihira" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a>  
            <a href="https://www.facebook.com/takuo.kihira" title="Facebook"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>    
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
