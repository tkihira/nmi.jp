<!DOCTYPE html>
<html>

  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>JavaScript における VM の高速化手法</title>
    <meta name="description" content="この記事は、JavaScript で Flash Player の実現を頑張った（もしくは現在進行系で頑張っている）人たちの集う Flash Advent Calendar 2020 に参加しております。皆さん、JavaScript で VM を実装する経験をお持ちでしょうか？私は過去に Java VM と Ac...">

    <link rel="stylesheet" href=" /css/fontawesome/css/font-awesome.min.css ">
    <link rel="stylesheet" href=" /css/main.css ">
    <link rel="canonical" href="https://nmi.jp/2020-12-20-Make_VM_faster">
    <link rel="alternate" type="application/rss+xml" title="nmi.jp" href="https://nmi.jp/feed.xml">
    <link rel="author" href="https://www.hatena.ne.jp/tkihira/" />
<script type='text/javascript' src='//platform.twitter.com/widgets.js?ver=3.0'></script>
<!-- <script type='text/javascript' src='//platform.twitter.com/widgets.js?ver=1.1'></script> -->
    <script>
        if(location.href.match(/\.html$/)) {
            location.href = location.href.match(/(.+)\.html/)[1];
        }
    </script>


<!-- Global Site Tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-229769-8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-229769-8');
</script>
</head>


  <body>

    <header id="top">
    <div class="wrapper">
        <a href="/" class="brand">nmi.jp</a>
        <small>Twitter → <a href="https://twitter.com/tkihira" target="_blank">@tkihira</a></small>
        <button id="headerMenu" class="menu"><i class="fa fa-bars"></i></button>
        <nav id="headerNav">
            <ul>
                <li>
                    
                    <a href="/">
                    
                        <i class="fa fa-home"></i>Home
                    </a>
                </li>

                
                    
                    <li>
                        
                        <a href="/archive/">
                        
                            <i class="fa fa-archive"></i>Archives
                        </a>
                    </li>
                    
                
                    
                    <li>
                        
                        <a href="/category/">
                        
                            <i class="fa fa-th-list"></i>Categories
                        </a>
                    </li>
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
                    
                
            </ul>
        </nav>
    </div>
</header>


        <div class="page clearfix" post>
    <div class="left">
        <div class="post-recent">
    <table style="width:100%;border:0;padding:0;"><tbody><tr style="padding:0">
        <td class="toppre" style="padding:0">
        
        <a href="/2020-12-17-globalCompositeOperation">知られざる globalCompositeOperation テクニック</a>
        
        </td><td class="topnex" style="text-align:right;padding:0">
        
        <a href="/2020-12-22-Lazy-evaluation">JavaScript で遅延評価を導入して起動を高速化した話</a>
        
        </td>
    </tr></tbody></table>
</div>

        <hr style="margin:0"/>
        <h1 style="margin-top:10px">JavaScript における VM の高速化手法</h1>
<hr />
        <div class="label">

            <div class="label-card">
                <i class="fa fa-calendar"></i>2020-12-20
            </div>

            <div class="label-card">
                <i class="fa fa-user"></i>Takuo Kihira
                
            </div>

            <div class="label-card">
                
            </div>

            <div class="label-card">
            


<!-- <span class="point">•</span> -->
<span class="categories">
  <i class="fa fa-th-list"></i>
  
    
        <a href="/category/#JavaScript" title="Category: JavaScript" rel="category">JavaScript</a>
    
  

  <!-- <span class="point">•</span> -->
</span>


            </div>

            <div class="label-card">
                <a href="https://github.com/tkihira/nmi.jp/blob/master/_posts/2020-12-20-Make_VM_faster.md" target="_blank"><i class="fa fa-github"></i></a>
            </div>

        </div>

<div class="entry fix" style="overflow:hidden;">
    <div style="height:33px; padding-top:2px; padding-bottom:2px; clear:both;" class="really_simple_share"><div style="float:left; width:100px; " class="really_simple_share_facebook_like"> 
				<iframe src="//www.facebook.com/plugins/like.php?href=https://nmi.jp/2020-12-20-Make_VM_faster&amp;layout=button_count&amp;show_faces=false&amp;width=100&amp;action=like&amp;colorscheme=light&amp;height=27" 
					scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:27px;" allowTransparency="true"></iframe>
			</div><div style="float:left; width:110px; padding-left:10px;" class="really_simple_share_twitter"> 
				<a href="//twitter.com/share" class="twitter-share-button" data-count="horizontal" 
					data-text="JavaScript における VM の高速化手法" data-url="https://nmi.jp/2020-12-20-Make_VM_faster">Tweet</a> 
			</div><div style="float:left; padding-left:10px;" class="really_simple_share_hyves">
					<a href="//b.hatena.ne.jp/entry/https://nmi.jp/2020-12-20-Make_VM_faster" class="hatena-bookmark-button"
					data-hatena-bookmark-layout="standard" title="JavaScript における VM の高速化手法"
					><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="JavaScript における VM の高速化手法" width="20"
					height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js"
					charset="utf-8" async="async"></script>
				</div>
</div>
</div>
        <article itemscope itemtype="//schema.org/BlogPosting">
        <p>この記事は、JavaScript で Flash Player の実現を頑張った（もしくは現在進行系で頑張っている）人たちの集う <a href="https://qiita.com/advent-calendar/2020/flash">Flash Advent Calendar 2020</a> に参加しております。</p>

<p>皆さん、JavaScript で VM を実装する経験をお持ちでしょうか？私は過去に Java VM と ActionScript VM を JavaScript で実装したことがあります。Flash Player において VM は最も重い場所になることが多く、ここの高速化は Engine 全体の性能に大きく寄与します。この記事では、私が <a href="https://github.com/PexJS/PexJS">Pex.js</a> にて導入し、素晴らしい成果をあげた VM の高速化手法をご紹介しましょう。</p>

<p>とはいえ<span style="color:blue">今更 ActionScript の VM の話をされても困る</span>と思うので、この記事では簡単な Java VM のサブセットをターゲットにして説明をします。</p>

<h1 id="vm-virtual-machine-とは">VM (Virtual Machine) とは</h1>

<p>VM (Virtual Machine) という単語は様々なコンテキストで使われます。特にインフラ周りでは仮想化技術の文脈で使われ、そちらの利用例が一般的だと思いますが、プログラミング言語の文脈で VM という場合は「言語の出力を実行可能な仮想的な機械」を指すことが多いです。たとえば Java VM は、Java をコンパイルしたバイトコードを実行出来ますし、ActionScript の VM は同じ様にコンパイルされた ActionScript を実行します。これらの VM はスタックマシンを採用していることが多いです。</p>

<p>言語の VM（たとえば Java VM）自体をそれぞれの CPU プラットフォーム（例えば Intel であったり ARM であったり）で実装することで、プラットフォーム間の互換性を高い水準で維持することが出来るようになるのが特徴です。一方で、最初から特定の CPU プラットフォームをターゲットにしたコンパイラに比べると、実行速度の面で不利があることが多いです。</p>

<p>その不利を減らすべく、色々な VM 実装においては JIT (Just In Time compiler) などの技術を駆使して高速化を頑張っています。</p>

<h1 id="jvm-のバイトコードを見てみる">JVM のバイトコードを見てみる</h1>

<p>実物を元にご説明しましょう。こちら、10000 までの整数を足し算する Java のプログラムです。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">class</span> <span class="nc">Test</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">a</span> <span class="o">+=</span> <span class="n">i</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>これを javac でコンパイルすると、次のような class ファイルを得られました。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ javac Test.java
$ xxd Test.class 
00000000: cafe babe 0000 0034 0010 0a00 0300 0d07  .......4........
00000010: 000e 0700 0f01 0006 3c69 6e69 743e 0100  ........&lt;init&gt;..
00000020: 0328 2956 0100 0443 6f64 6501 000f 4c69  .()V...Code...Li
00000030: 6e65 4e75 6d62 6572 5461 626c 6501 0004  neNumberTable...
00000040: 7465 7374 0100 0328 2949 0100 0d53 7461  test...()I...Sta
00000050: 636b 4d61 7054 6162 6c65 0100 0a53 6f75  ckMapTable...Sou
00000060: 7263 6546 696c 6501 0009 5465 7374 2e6a  rceFile...Test.j
00000070: 6176 610c 0004 0005 0100 0454 6573 7401  ava........Test.
00000080: 0010 6a61 7661 2f6c 616e 672f 4f62 6a65  ..java/lang/Obje
00000090: 6374 0020 0002 0003 0000 0000 0002 0000  ct. ............
000000a0: 0004 0005 0001 0006 0000 001d 0001 0001  ................
000000b0: 0000 0005 2ab7 0001 b100 0000 0100 0700  ....*...........
000000c0: 0000 0600 0100 0000 0100 0100 0800 0900  ................
000000d0: 0100 0600 0000 4f00 0200 0300 0000 1703  ......O.........
000000e0: 3c03 3d1c 1127 10a2 000d 1b1c 603c 8402  &lt;.=..'......`&lt;..
000000f0: 01a7 fff2 1bac 0000 0002 0007 0000 0016  ................
00000100: 0005 0000 0003 0002 0004 000b 0005 000f  ................
00000110: 0004 0015 0007 000a 0000 000a 0002 fd00  ................
00000120: 0401 01fa 0010 0001 000b 0000 0002 000c  ................
</code></pre></div></div>

<p>この中で、</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>03 3c 03 3d 1c 11 27 10 a2 00 0d 1b 1c 60 3c 84 02 01 a7 ff f2 1b ac
</code></pre></div></div>

<p>これが test のバイトコードになります。javap でインストラクションを確認してみましょう。</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ javap -c Test.class
(...抜粋...)
    Code:
       0: iconst_0
       1: istore_1
       2: iconst_0
       3: istore_2
       4: iload_2
       5: sipush        10000
       8: if_icmpge     21
      11: iload_1
      12: iload_2
      13: iadd
      14: istore_1
      15: iinc          2, 1
      18: goto          4
      21: iload_1
      22: ireturn
</code></pre></div></div>

<p>これらのインストラクションはバイトコードと 1 対 1 に対応しております。例えば <code class="language-plaintext highlighter-rouge">iconst_0</code> は <code class="language-plaintext highlighter-rouge">0x03</code>、<code class="language-plaintext highlighter-rouge">istore_1</code> は <code class="language-plaintext highlighter-rouge">0x3c</code>、<code class="language-plaintext highlighter-rouge">sipush 10000</code> はオペコードが <code class="language-plaintext highlighter-rouge">0x11</code>、オペランドが <code class="language-plaintext highlighter-rouge">0x27 0x10</code> (0x2710 == 10000) になります。</p>

<p>VM によってこれを逐次実行していくことで、最終的に Java のプログラムが実行出来るようになるわけです。</p>

<h1 id="vm-を作ってみよう">VM を作ってみよう</h1>

<p>では、上記のプログラムを実行するだけの簡単な VM を実際に JavaScript で作ってみましょう！</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bytecode</span> <span class="o">=</span> 
    <span class="p">[</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">,</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">,</span><span class="mh">0x10</span><span class="p">,</span>
     <span class="mh">0xa2</span> <span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
     <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">];</span>

<span class="kd">function</span> <span class="nf">vm</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">programCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">variableTable</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
    <span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>

    <span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mh">0x03</span><span class="p">:</span> <span class="c1">// iconst_0</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x3c</span><span class="p">:</span> <span class="c1">// istore_1</span>
                <span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x3d</span><span class="p">:</span> <span class="c1">// istore_2</span>
                <span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x1b</span><span class="p">:</span> <span class="c1">// iload_1</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x1c</span><span class="p">:</span> <span class="c1">// iload_2</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x11</span><span class="p">:</span> <span class="c1">// sipush</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]);</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xa2</span><span class="p">:</span> <span class="c1">// if_icmpge</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">())</span> <span class="p">{</span>
                    <span class="nx">programCounter</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x60</span><span class="p">:</span> <span class="c1">// iadd</span>
                <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">());</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x84</span><span class="p">:</span> <span class="c1">// iinc</span>
                <span class="nx">variableTable</span><span class="p">[</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">+=</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xa7</span><span class="p">:</span> <span class="c1">// goto</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xac</span><span class="p">:</span> <span class="c1">// ireturn</span>
                <span class="k">return</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nf">vm</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">));</span>
</code></pre></div></div>

<p>bytecode を入力すると、その実行結果を返す VM が完成しました。簡単ですね！Wikipedia の <a href="https://en.wikipedia.org/wiki/Java_bytecode_instruction_listings">Java bytecode instruction listings</a> を見ながら作りました。</p>

<ul>
  <li>programCounter は、今動かしているバイトコードのオフセットを記録しています</li>
  <li>通常は programCounter は 1 つだけ動きますが、オペランドのあるオペコード（<code class="language-plaintext highlighter-rouge">sipush</code>, <code class="language-plaintext highlighter-rouge">if_icmpge</code>, <code class="language-plaintext highlighter-rouge">iinc</code>）の場合はオペコード分も移動します</li>
  <li><code class="language-plaintext highlighter-rouge">if_icmpge</code> で条件を満たした場合と <code class="language-plaintext highlighter-rouge">goto</code> ではジャンプします。一番上のビットが立っている場合はマイナス方向へのジャンプになり、<code class="language-plaintext highlighter-rouge">&lt;&lt;16 &gt;&gt;16</code> によって 16bit から 32bit に符号拡張しています。</li>
</ul>

<p>これを実行すると、以下のように 0〜9999 を加算する Java のプログラムが実行されているのが確認出来ますね！</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ node vm.js
49995000
</code></pre></div></div>

<h1 id="vm-のパフォーマンス">VM のパフォーマンス</h1>

<p>さて、パフォーマンスを見てみましょう。次のようなコードを書きました</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">native</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">a</span> <span class="o">+=</span> <span class="nx">i</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">vm</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`VM: </span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">}</span><span class="s2">ms`</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">native</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`Native: </span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">}</span><span class="s2">ms`</span><span class="p">);</span>
</code></pre></div></div>

<p>純粋なパフォーマンスを計るためにはかなり不適当なコードですが、とりあえず目をつぶってこれを実行すると、出力は以下の通りでした</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>VM: 4308ms
Native: 77ms
</code></pre></div></div>

<p>VM の方が 60 倍くらい遅いです。関数呼び出しのコストも計測しているので、実際はもっともっと遅いと思います（そもそも V8 の JIT によって native 関数のループが定数に置換されてそうですし）。まあ「ものすごく遅い」ということが確認出来たので良いでしょう。</p>

<h1 id="vm-の高速化アイデア">VM の高速化アイデア</h1>

<p>さて、これをどのように高速化すればいいでしょうか。ここで一つ、次のプログラムを考えてみましょう。</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Test2</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">test2</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="mi">1</span><span class="o">;</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">;</span>
        <span class="n">a</span> <span class="o">+=</span> <span class="mi">3</span><span class="o">;</span>
        <span class="k">return</span> <span class="n">a</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>インストラクションは以下の通りです</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bytecode: 03 3c 84 01 01 84 01 02 84 01 03 1b ac
    Code:
       0: iconst_0
       1: istore_1
       2: iinc          1, 1
       5: iinc          1, 2
       8: iinc          1, 3
      11: iload_1
      12: ireturn
</code></pre></div></div>

<p>先程の VM 実装は switch 文でループしながら各インストラクションを評価しているのですが、<span style="color:red">bytecode から JavaScript の関数を直接作ってしまうことが出来そう</span>ではないでしょうか？これが JavaScript による VM の高速化の基本的なアイデアとなります。具体的には次のようなコードです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bytecode</span> <span class="o">=</span> 
    <span class="p">[</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
     <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">];</span>

<span class="kd">function</span> <span class="nf">makeFunctionStringFromBytecode</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">programCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">funcStr</span> <span class="o">=</span> <span class="s2">`
const variableTable = [null, 0, 0];
const stack = [];
`</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="nx">programCounter</span> <span class="o">&lt;</span> <span class="nx">bytecode</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mh">0x03</span><span class="p">:</span> <span class="c1">// iconst_0</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`stack.push(0);\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x3c</span><span class="p">:</span> <span class="c1">// istore_1</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`variableTable[1] = stack.pop();\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x1b</span><span class="p">:</span> <span class="c1">// iload_1</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`stack.push(variableTable[1]);\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x84</span><span class="p">:</span> <span class="c1">// iinc</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`variableTable[</span><span class="p">${</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]}</span><span class="s2">] += </span><span class="p">${</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]}</span><span class="s2">;\n`</span><span class="p">;</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xac</span><span class="p">:</span> <span class="c1">// ireturn</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`return stack.pop();\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">funcStr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">funcStr</span> <span class="o">=</span> <span class="nf">makeFunctionStringFromBytecode</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">funcStr</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">// Result: </span><span class="dl">"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="nx">funcStr</span><span class="p">)())</span>
</code></pre></div></div>

<p>説明のため、<code class="language-plaintext highlighter-rouge">test2</code> で使用されているニーモニックに限定した実装になっております。この <code class="language-plaintext highlighter-rouge">makeFunctionStringFromBytecode</code> を実行すると、bytecode から直接 JavaScript のプログラム文字列を生成してくれます。あとはこれを <code class="language-plaintext highlighter-rouge">new Function</code> で関数化して実行すれば、switch 文のループを必要としない実行関数を得ることが出来ます。簡単に言うと、<span style="color:red">JavaScript の中で JavaScript を動的に生成し、それを実行する</span>ということです。このコードの出力は次の通りです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">variableTable</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
<span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
<span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
<span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
<span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
<span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="k">return</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>

<span class="c1">// Result: 6</span>
</code></pre></div></div>

<p>上の部分が動的に生成された JavaScript の文字列で、下の Result がそれを <code class="language-plaintext highlighter-rouge">new Function</code> で関数化し実行した結果となります。見ただけで、switch 文の実装よりも圧倒的に速そうに見えますね！</p>

<h1 id="jump-命令">Jump 命令</h1>

<p>しかしここで一つ壁があります。インストラクションの中に、<code class="language-plaintext highlighter-rouge">if_icmpge</code> と <code class="language-plaintext highlighter-rouge">goto</code> というジャンプ命令がありました。しかし JavaScript は goto 文を持っておりません。ジャンプ命令に対応するためには、どうすればよいでしょうか？</p>

<p>最も簡単なやり方は、switch 文を使うことです。switch 文発祥の地の C 言語において、switch 文のラベルは goto とほぼ同じ機能を持ちます。同じ構文を持つ JavaScript においても、switch 文を活用することで<span style="color:red">疑似 goto 文<span>を作り出すことが出来ます。</span></span></p>

<p>具体的には、全体を switch 文で囲み、それぞれのインストラクションの場所に label を用意しておきます。そして goto の必要があるところで、一旦 switch 文から離脱し、改めて label の位置から switch 文を開始するやり方になります。</p>

<p>実際にコードを書いてみましょう。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">bytecode</span> <span class="o">=</span> 
    <span class="p">[</span><span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="p">,</span><span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x27</span> <span class="p">,</span><span class="mh">0x10</span><span class="p">,</span>
     <span class="mh">0xa2</span> <span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
     <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0xa7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xf2</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xac</span><span class="p">];</span>

<span class="kd">function</span> <span class="nf">makeFunctionStringFromBytecode</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">programCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">funcStr</span> <span class="o">=</span> <span class="s2">`
const variableTable = [null, 0, 0];
const stack = [];
let gotoLable = 'label0';
while(true) {
  switch(gotoLable) {
`</span><span class="p">;</span>

    <span class="k">while</span><span class="p">(</span><span class="nx">programCounter</span> <span class="o">&lt;</span> <span class="nx">bytecode</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`  case 'label</span><span class="p">${</span><span class="nx">programCounter</span><span class="p">}</span><span class="s2">':\n`</span><span class="p">;</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span><span class="p">])</span> <span class="p">{</span>
            <span class="k">case</span> <span class="mh">0x03</span><span class="p">:</span> <span class="c1">// iconst_0</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    stack.push(0);\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x3c</span><span class="p">:</span> <span class="c1">// istore_1</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    variableTable[1] = stack.pop();\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x3d</span><span class="p">:</span> <span class="c1">// istore_2</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    variableTable[2] = stack.pop();\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x1b</span><span class="p">:</span> <span class="c1">// iload_1</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    stack.push(variableTable[1]);\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x1c</span><span class="p">:</span> <span class="c1">// iload_2</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    stack.push(variableTable[2]);\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x11</span><span class="p">:</span> <span class="c1">// sipush</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    stack.push(</span><span class="p">${</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]}</span><span class="s2">);\n`</span><span class="p">;</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xa2</span><span class="p">:</span> <span class="c1">// if_icmpge</span>
                <span class="p">{</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    if(stack.pop() &lt;= stack.pop()) {\n`</span><span class="p">;</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`      gotoLable = 'label</span><span class="p">${</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="p">((</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)}</span><span class="s2">';\n`</span><span class="p">;</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`      break;\n`</span><span class="p">;</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    }\n`</span><span class="p">;</span>
                    <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="mh">0x60</span><span class="p">:</span> <span class="c1">// iadd</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    stack.push(stack.pop() + stack.pop());\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0x84</span><span class="p">:</span> <span class="c1">// iinc</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    variableTable[</span><span class="p">${</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]}</span><span class="s2">] += </span><span class="p">${</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]}</span><span class="s2">;\n`</span><span class="p">;</span>
                <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="mh">0xa7</span><span class="p">:</span> <span class="c1">// goto</span>
                <span class="p">{</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    gotoLable = 'label</span><span class="p">${</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="p">((</span><span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="nx">bytecode</span><span class="p">[</span><span class="nx">programCounter</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)}</span><span class="s2">';\n`</span><span class="p">;</span>
                    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    break;\n`</span><span class="p">;</span>
                    <span class="nx">programCounter</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="k">case</span> <span class="mh">0xac</span><span class="p">:</span> <span class="c1">// ireturn</span>
                <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`    return stack.pop();\n`</span><span class="p">;</span> <span class="nx">programCounter</span><span class="o">++</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nx">funcStr</span> <span class="o">+=</span> <span class="s2">`  }\n}`</span><span class="p">;</span>
    <span class="k">return</span> <span class="nx">funcStr</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">funcStr</span> <span class="o">=</span> <span class="nf">makeFunctionStringFromBytecode</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">)</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">funcStr</span><span class="p">);</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">// Result: </span><span class="dl">"</span> <span class="o">+</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="nx">funcStr</span><span class="p">)())</span>
</code></pre></div></div>

<p>この実装の大まかなアイデアは次の通りです。</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">while(true)</code> と <code class="language-plaintext highlighter-rouge">switch(gotoLable)</code> で全体をくくる</li>
  <li>全てのインストラクションの変換時の直前に <code class="language-plaintext highlighter-rouge">case 'labelXXX':</code> というラベル（XXX はprogramCounter）を生成し、これらのラベルをジャンプ対象にする</li>
  <li>ジャンプが必要ない場合は break をつけず、次の命令を実行させる</li>
  <li>ジャンプ命令の場合は飛び先のラベルを <code class="language-plaintext highlighter-rouge">gotoLable</code> に代入した上で break する</li>
</ul>

<p><code class="language-plaintext highlighter-rouge">if_icmpge</code> と <code class="language-plaintext highlighter-rouge">goto</code> において、<code class="language-plaintext highlighter-rouge">gotoLabel</code> に適切な分岐先を代入した上で break しているのがご確認いただけると思います。これによって分岐命令が来たタイミングで一旦 switch 文の外にでて、再び <code class="language-plaintext highlighter-rouge">while(true)</code> によって switch 文により適切なラベルの場所から実行が開始される仕組みです。</p>

<p>このコードの実行結果は以下の通りです。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">variableTable</span> <span class="o">=</span> <span class="p">[</span><span class="kc">null</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">];</span>
<span class="kd">const</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
<span class="kd">let</span> <span class="nx">gotoLable</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">label0</span><span class="dl">'</span><span class="p">;</span>
<span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="nx">gotoLable</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label0</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label1</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label2</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label3</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label4</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label5</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="mi">10000</span><span class="p">);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label8</span><span class="dl">'</span><span class="p">:</span>
    <span class="k">if</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">())</span> <span class="p">{</span>
      <span class="nx">gotoLable</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">label21</span><span class="dl">'</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label11</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label12</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label13</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">()</span> <span class="o">+</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">());</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label14</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label15</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">variableTable</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label18</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">gotoLable</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">label4</span><span class="dl">'</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label21</span><span class="dl">'</span><span class="p">:</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">variableTable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="k">case</span> <span class="dl">'</span><span class="s1">label22</span><span class="dl">'</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">// Result: 49995000</span>
</code></pre></div></div>

<p>このように、実行時にバイトコードから JavaScript の関数を直接出力する、いわば JIT のような機能を持たせることによって、大幅な高速化が可能になります</p>

<h1 id="パフォーマンス">パフォーマンス</h1>

<p>前回の結果は 1 万回の実行に 4308ms かかっていましたが、さーて、どれくらい速くなっているでしょうか。検証用のコードを書いてみましょう。</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">funcStr</span> <span class="o">=</span> <span class="nf">makeFunctionStringFromBytecode</span><span class="p">(</span><span class="nx">bytecode</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">func</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="nx">funcStr</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">count</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">startTime</span> <span class="o">=</span> <span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">();</span>
<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nf">func</span><span class="p">();</span>
<span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`New VM: </span><span class="p">${</span><span class="nb">Date</span><span class="p">.</span><span class="nf">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">startTime</span><span class="p">}</span><span class="s2">ms`</span><span class="p">);</span>
</code></pre></div></div>

<p>実行結果はこちら</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>New VM: 1970ms
</code></pre></div></div>

<p><span style="color:red">なんと 2.2 倍もの速度を達成しました！</span>なお実運用においては、実際の ActionScript はもっと複雑なものが多いので、さらなる高速化を実現出来ていました。素晴らしいですね！</p>

<h1 id="なお今なら">なお、今なら…</h1>

<p>しかし、これは 10 年前から 7 年前の話です。もし今同じ実装をやるならば、絶対に WebAssembly(wasm) の動的生成を開発すべきでしょう。WebAssembly にも goto そのものの命令はないのですが、上記 switch と同じような手法で出来るでしょう。ActionScript もスタックマシンで wasm と同じですし、実装はかなり簡単だと思います。</p>

<p>とはいえ、switch 文を使った goto テクニックなどは、このようなコード自動生成においては有用なテクニックではあります。wasm の bytecode を動的に生成する場合にも参考になるでしょう。このブログ記事が皆さんの刺激になり、新しい高速化のアイデアの源になれば幸いです。</p>

        </article>
        <hr>

<div class="entry fix" style="overflow:hidden;">
    <div style="height:33px; padding-top:2px; padding-bottom:2px; clear:both;" class="really_simple_share"><div style="float:left; width:100px; " class="really_simple_share_facebook_like"> 
				<iframe src="//www.facebook.com/plugins/like.php?href=https://nmi.jp/2020-12-20-Make_VM_faster&amp;layout=button_count&amp;show_faces=false&amp;width=100&amp;action=like&amp;colorscheme=light&amp;height=27" 
					scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:27px;" allowTransparency="true"></iframe>
			</div><div style="float:left; width:110px; padding-left:10px;" class="really_simple_share_twitter"> 
				<a href="//twitter.com/share" class="twitter-share-button" data-count="horizontal" 
					data-text="JavaScript における VM の高速化手法" data-url="https://nmi.jp/2020-12-20-Make_VM_faster">Tweet</a> 
			</div><div style="float:left; padding-left:10px;" class="really_simple_share_hyves">
					<a href="//b.hatena.ne.jp/entry/https://nmi.jp/2020-12-20-Make_VM_faster" class="hatena-bookmark-button"
					data-hatena-bookmark-layout="standard" title="JavaScript における VM の高速化手法"
					><img src="//b.st-hatena.com/images/entry-button/button-only.gif" alt="JavaScript における VM の高速化手法" width="20"
					height="20" style="border: none;" /></a><script type="text/javascript" src="//b.st-hatena.com/js/bookmark_button.js"
					charset="utf-8" async="async"></script>
				</div>
</div>
</div>

        
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
            
            
        
        

        <div class="post-recent">
    <div class="pre">

    
        <p><strong>前の投稿</strong> <a href="/2020-12-17-globalCompositeOperation">知られざる globalCompositeOperation テクニック</a></p>
    
    </div>
    <div class="nex">

        
        <p><strong>次の投稿</strong> <a href="/2020-12-22-Lazy-evaluation">JavaScript で遅延評価を導入して起動を高速化した話</a></p>
        
    </div>
</div>


    </div>
    <button class="anchor"><i class="fa fa-anchor"></i></button>


    <div class="right">
        <div class="wrap">
            <div class="side">
                <div>
                    <i class="fa fa-tags"></i>
                    Top Popular Posts
                </div>
                <ul class="content-ul" recent>
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/2016-07-23-stock-strategy-for-early-startup-employee">スタートアップに転職する時に最低限知っておくべき株の話</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/582">生WebGL入門:初音ミクの美麗3Dモデルを表示する(前編)</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/2017-10-06-Making_a-business_plan">事業計画書の作り方、新規ビジネスの考え方</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/902">Convertible Note / Convertible Equity とは？</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/488">JavaScript イディオム集</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                            <li><a href="/archives/465">ExGameの製作で感じたこと</a></li>
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                          
                        
                    
                </ul>
            </div>

            <div class="side">
                <div>
                    <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
                    Recent Posts
                </div>
                <ul class="content-ul" recent>
                    
                        <li><a href="/2024-08-28-Review-Binary-Hacks-Rebooted">書評 "Binary Hacks Rebooted"</a></li>
                    
                        <li><a href="/2024-06-10-Deep-Dive-into-ARM-JavaScript-Special-Instruction-FJCVTZS">ARM に存在する JavaScript 専用命令「FJCVTZS」を追う（ついでに V8 をビルドする）</a></li>
                    
                        <li><a href="/2024-06-03-Exploring-V8-JIT-Outputs">JavaScript 実行エンジン V8 の JIT 出力コードを読んでみよう</a></li>
                    
                </ul>
            </div>

            <!-- <div class="side">
                <div>
                    <i class="fa fa-external-link"></i>
                    Links
                </div>
                <ul  class="content-ul">

                </ul>
            </div> -->
        </div>
    </div>



</div>
<script>
/**
 * target _blank
 */
(function() {
    var aTags = document.querySelectorAll('article a:not([id])')
    for (var i = 0; i < aTags.length; i++) {
        aTags[i].setAttribute('target', '_blank')
    }
}());
</script>
<script src="/js/pageContent.js " charset="utf-8"></script>


    <footer class="site-footer">


    <div class="wrapper">

        <p class="description">
             Takuo Kihira 
        </p>
        <p class="contact">
            Contact me at: 
            <a href="https://github.com/tkihira" title="GitHub"><i class="fa fa-github" aria-hidden="true"></i></a>     
            <a href="https://twitter.com/tkihira" title="Twitter"><i class="fa fa-twitter" aria-hidden="true"></i></a>  
            <a href="https://www.facebook.com/takuo.kihira" title="Facebook"><i class="fa fa-facebook-official" aria-hidden="true"></i></a>    
        </p>
        <p class="power">
            <span>
                Site powered by <a href="https://jekyllrb.com/">Jekyll</a>.
            </span>
            <span>
                Theme designed by <a href="https://github.com/Gaohaoyang">HyG</a>.
            </span>
        </p>
    </div>
</footer>

    <div class="back-to-top">
    <a href="#top" class="scroll">
        <i class="fa fa-arrow-up" aria-hidden="true"></i>
    </a>
</div>

    <script src=" /js/main.js " charset="utf-8"></script>
    <script src=" /js/scroll.min.js " charset="utf-8"></script>
  </body>

</html>
